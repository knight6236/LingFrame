# å…±äº« API è®¾è®¡è§„èŒƒ

## æ¶æ„æ¦‚è¿°

```
å®¿ä¸» ClassLoader (AppClassLoader)
    â†“ parent
SharedApiClassLoader (å…±äº« API å±‚)
    â†“ parent
PluginClassLoader (æ’ä»¶å®ç°å±‚)
```

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. API ç”±æ¶ˆè´¹æ–¹æä¾›ï¼ˆæ¶ˆè´¹è€…é©±åŠ¨å¥‘çº¦ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¶ˆè´¹è€…é©±åŠ¨å¥‘çº¦æ¨¡å¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯ï¼šOrder æ’ä»¶éœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     éœ€è¦èƒ½åŠ›      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Order æ’ä»¶  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  User æ’ä»¶   â”‚
â”‚  (æ¶ˆè´¹è€…)    â”‚                  â”‚  (ç”Ÿäº§è€…)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â–²
       â”‚ 1. å®šä¹‰æ‰€éœ€æ¥å£               â”‚ 2. å®ç°æ¶ˆè´¹è€…å®šä¹‰çš„æ¥å£
       â–¼                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      order-api æ¨¡å—                          â”‚
â”‚          (ç”±æ¶ˆè´¹è€… Order æ’ä»¶å®šä¹‰å’Œç»´æŠ¤)                       â”‚
â”‚                                                              â”‚
â”‚   public interface UserQueryService {                        â”‚
â”‚       Optional<UserDTO> findById(String userId);             â”‚
â”‚   }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŸåˆ™**ï¼š
- API æ¥å£ç”±**æ¶ˆè´¹æ–¹**å®šä¹‰å’Œç»´æŠ¤ï¼ˆè°éœ€è¦èƒ½åŠ›ï¼Œè°å®šä¹‰æ¥å£ï¼‰
- ç”Ÿäº§æ–¹**å®ç°**æ¶ˆè´¹æ–¹å®šä¹‰çš„æ¥å£ï¼ˆè°æœ‰èƒ½åŠ›ï¼Œè°æä¾›å®ç°ï¼‰
- æ¶ˆè´¹æ–¹æœ€äº†è§£è‡ªå·±éœ€è¦ä»€ä¹ˆåŠŸèƒ½ï¼Œæ¥å£è®¾è®¡æ›´è´´åˆå®é™…éœ€æ±‚

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- ä¼ ç»Ÿæ¨¡å¼ï¼šUser æ’ä»¶å®šä¹‰ `UserService`ï¼Œæ‰€æœ‰æ¶ˆè´¹è€…é€‚é…ç”Ÿäº§è€…çš„æ¥å£
- æ¶ˆè´¹è€…é©±åŠ¨ï¼šOrder æ’ä»¶å®šä¹‰ `UserQueryService`ï¼ˆåªåŒ…å«å®ƒéœ€è¦çš„æ–¹æ³•ï¼‰ï¼ŒUser æ’ä»¶é€‚é…æ¶ˆè´¹è€…éœ€æ±‚
- ä¼˜åŠ¿ï¼šè§£è€¦æ›´å½»åº•ï¼Œæ¶ˆè´¹è€…ä¸ä¾èµ–ç”Ÿäº§è€…çš„å…¨é‡æ¥å£ï¼Œå¯ç‹¬ç«‹æ¼”è¿›

---

## API æ¨¡å—ç»“æ„

### 2. API æ¨¡å—åªåŒ…å«æ¥å£å’Œ DTO

æ¶ˆè´¹è€…ï¼ˆOrder æ’ä»¶ï¼‰å®šä¹‰å®ƒéœ€è¦çš„æ¥å£ï¼Œç”Ÿäº§è€…ï¼ˆUser æ’ä»¶ï¼‰å®ç°ï¼š

```
order-api/                              # æ¶ˆè´¹è€… Order æ’ä»¶çš„ API æ¨¡å—
â”œâ”€â”€ src/main/java/com/example/order/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ UserQueryService.java      # Order éœ€è¦çš„ç”¨æˆ·æŸ¥è¯¢èƒ½åŠ›ï¼ˆç”± User æ’ä»¶å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ PaymentService.java        # Order éœ€è¦çš„æ”¯ä»˜èƒ½åŠ›ï¼ˆç”± Payment æ’ä»¶å®ç°ï¼‰
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ UserDTO.java               # ç”¨æˆ·æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â””â”€â”€ PaymentResultDTO.java
â””â”€â”€ pom.xml
```

**ä¸åº”è¯¥åŒ…å«**ï¼š
- âŒ ä¸šåŠ¡é€»è¾‘å®ç°
- âŒ æ•°æ®åº“è®¿é—®ä»£ç 
- âŒ Spring ç»„ä»¶ï¼ˆ@Service, @Repository ç­‰ï¼‰
- âŒ æ²»ç†é€»è¾‘ï¼ˆç†”æ–­ã€é‡è¯•ç­‰ï¼‰

### 3. DTO è®¾è®¡è§„èŒƒ

```java
// âœ… æ­£ç¡®ï¼šç®€å• POJOï¼Œå¯åºåˆ—åŒ–
@Data
public class OrderDTO implements Serializable {
    private Long id;
    private String orderNo;
    private BigDecimal amount;
    private LocalDateTime createTime;
}

// âŒ é”™è¯¯ï¼šåŒ…å«ä¸šåŠ¡é€»è¾‘æˆ–å¤æ‚ä¾èµ–
public class OrderDTO {
    private Order order;  // ä¸è¦å¼•ç”¨å®ä½“ç±»
    public void process() { ... }  // ä¸è¦æœ‰ä¸šåŠ¡æ–¹æ³•
}
```

### 3. é¿å…é‡é‡çº§ä¾èµ–

API æ¨¡å—çš„ä¾èµ–åº”è¯¥å°½é‡ç²¾ç®€ï¼š

```xml
<!-- âœ… æ¨èçš„ä¾èµ– -->
<dependencies>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>provided</scope>
    </dependency>
</dependencies>

<!-- âŒ é¿å…çš„ä¾èµ– -->
<!-- ä¸è¦å¼•å…¥ Springã€æ•°æ®åº“é©±åŠ¨ç­‰é‡é‡çº§ä¾èµ– -->
```

## API æ¼”è¿›åŸåˆ™

### 4. å‘åå…¼å®¹ï¼ˆå¼ºçƒˆæ¨èï¼‰

```java
// âœ… æ­£ç¡®ï¼šåªå¢åŠ ï¼Œä¸ä¿®æ”¹
interface OrderService {
    Order getOrder(Long id);           // v1 ä¿ç•™
    List<Order> batchGet(List<Long> ids); // v2 æ–°å¢
}

// âŒ é”™è¯¯ï¼šä¿®æ”¹ç°æœ‰æ–¹æ³•ç­¾å
interface OrderService {
    OrderDTO getOrder(String orderId); // ç ´åå…¼å®¹ï¼
}
```

### 5. ç ´åæ€§å˜æ›´ä½¿ç”¨ç‰ˆæœ¬åŒ–åŒ…å

```java
// ç‰ˆæœ¬ 1
package com.example.order.api.v1;
public interface OrderService { ... }

// ç‰ˆæœ¬ 2ï¼ˆä¸å…¼å®¹ï¼‰
package com.example.order.api.v2;
public interface OrderService { ... }
```

ä¸¤ä¸ªç‰ˆæœ¬å¯ä»¥å…±å­˜äº SharedApiClassLoaderã€‚

## ç°åº¦å‘å¸ƒæ”¯æŒ

| åœºæ™¯ | æ”¯æŒ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| æ–°å¢ API æ–¹æ³• | âœ… | å¢é‡æ·»åŠ  JAR |
| ç ´åæ€§å˜æ›´ | âœ… | ç‰ˆæœ¬åŒ–åŒ…å |
| æ–°æ—§æ’ä»¶å…±å­˜ | âœ… | API å‘åå…¼å®¹ |

### ç°åº¦æµç¨‹ç¤ºä¾‹

```
T0: PluginA-v1 + API-v1
T1: æ·»åŠ  API-v2ï¼Œéƒ¨ç½² PluginA-v2ï¼ˆv1/v2 å…±å­˜ï¼‰
T2: éªŒè¯é€šè¿‡ï¼Œå¸è½½ PluginA-v1
```

## é…ç½®ç¤ºä¾‹

```yaml
lingframe:
  preload-api-jars:
    - api/order-api-*.jar      # é€šé…ç¬¦åŠ è½½å¤šç‰ˆæœ¬
    - api/user-api/            # ç›®å½•è‡ªåŠ¨æ‰«æ
    - lingframe-examples/lingframe-example-order-api  # Maven æ¨¡å—ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
```

## å¸¸è§é—®é¢˜

### Q: ClassNotFoundException / NoClassDefFoundError

**åŸå› **ï¼šAPI æœªæ­£ç¡®åŠ è½½åˆ° SharedApiClassLoader

**æ£€æŸ¥**ï¼š
1. ç¡®è®¤ `preload-api-jars` é…ç½®æ­£ç¡®
2. ç¡®è®¤ JAR/ç›®å½•è·¯å¾„å­˜åœ¨
3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­çš„ `ğŸ“¦ [SharedApi]` è¾“å‡º

### Q: ClassCastException

**åŸå› **ï¼šåŒä¸€ä¸ªç±»è¢«ä¸åŒ ClassLoader åŠ è½½

**è§£å†³**ï¼šç¡®ä¿ API ç±»åªåœ¨ SharedApiClassLoader ä¸­åŠ è½½ï¼Œä¸è¦åœ¨æ’ä»¶ JAR ä¸­é‡å¤æ‰“åŒ…
